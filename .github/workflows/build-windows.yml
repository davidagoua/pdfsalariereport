
name: Build Windows App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # 1. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
          
      # 2. Build Python Sidecar
      - name: Build Python File
        run: |
          pyinstaller --name server --onefile --distpath src-tauri/binaries --clean run_server.py
          
      # 3. Setup Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        
      # 4. Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          
      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli
        
      # 5. Rename Sidecar for Tauri
      # Tauri expects: <command>-<target-triple>.exe
      - name: Rename Sidecar
        run: |
          cd src-tauri/binaries
          Move-Item server.exe server-x86_64-pc-windows-msvc.exe
          
      # 6. Build Tauri App
      - name: Build Tauri
        run: |
          cd src-tauri
          cargo tauri build
          
      # 7. Upload Artifacts
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: src-tauri/target/release/bundle/nsis/*.exe
